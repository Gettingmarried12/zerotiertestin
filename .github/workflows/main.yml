name: Windows-RDP-ZeroTier-AutoAuth

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Install ZeroTier
        run: |
          $msiPath = "$env:TEMP\ZeroTierOne.msi"
          Invoke-WebRequest -Uri "https://download.zerotier.com/dist/ZeroTier%20One.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i $msiPath /qn" -Wait
          Start-Sleep -s 10

      - name: Join and Auto-Authorize
        shell: powershell
        run: |
          $NW_ID = "${{ secrets.ZEROTIER_NETWORK_ID }}"
          $API_TOKEN = "${{ secrets.ZEROTIER_CENTRAL_TOKEN }}"
          
          # Join the network
          & "C:\Program Files (x86)\ZeroTier\One\zerotier-cli.bat" join $NW_ID
          Start-Sleep -s 5
          
          # Get this runner's Node ID
          $NODE_ID = (& "C:\Program Files (x86)\ZeroTier\One\zerotier-cli.bat" info).Split(' ')[2]
          Write-Host "Runner Node ID: $NODE_ID"

          # Use API to Authorize the member
          $authHeader = @{ "Authorization" = "Bearer $API_TOKEN" }
          $body = @{ config = @{ authorized = $true } } | ConvertTo-Json
          $url = "https://my.zerotier.com/api/v1/network/$NW_ID/member/$NODE_ID"
          
          Invoke-RestMethod -Method Post -Uri $url -Headers $authHeader -Body $body -ContentType "application/json"
          Write-Host "Successfully authorized $NODE_ID on network $NW_ID"

      - name: Enable RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          net user runneradmin "${{ secrets.RDP_PASSWORD }}"
          # Keeps runner alive
          Start-Sleep -s 21600
