- name: Join and Auto-Authorize
  shell: powershell
  run: |
    $NW_ID = "${{ secrets.ZEROTIER_NETWORK_ID }}"
    $API_TOKEN = "${{ secrets.ZEROTIER_CENTRAL_TOKEN }}"
    
    # 1. Join the network locally
    & "C:\Program Files (x86)\ZeroTier\One\zerotier-cli.bat" join $NW_ID
    Start-Sleep -s 10
    
    # 2. Get this runner's Node ID
    $NODE_ID = (& "C:\Program Files (x86)\ZeroTier\One\zerotier-cli.bat" info).Split(' ')[2]
    Write-Host "Runner Node ID: $NODE_ID"

    # 3. Construct the Authorization Header correctly
    # Note: Using "token" instead of "Bearer" often fixes 403 errors
    $headers = @{ 
        "Authorization" = "token $API_TOKEN"
        "Content-Type"  = "application/json"
    }

    # 4. Correct JSON Body format
    $body = @{ 
        config = @{ 
            authorized = $true 
        } 
    } | ConvertTo-Json -Depth 10

    # 5. Correct API Endpoint
    $url = "https://api.zerotier.com/api/v1/network/$NW_ID/member/$NODE_ID"
    
    # 6. Execute the Request
    try {
        Invoke-RestMethod -Method Post -Uri $url -Headers $headers -Body $body
        Write-Host "Successfully authorized $NODE_ID on network $NW_ID"
    } catch {
        Write-Error "Failed to authorize. Response: $_"
        exit 1
    }
